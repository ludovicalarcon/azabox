version: "3"

vars:
  BINARY_NAME: azabox
  BIN: "{{.PWD}}/bin/{{.BINARY_NAME}}"

  TOOLS_FOLDER: "{{.PWD}}/bin"
  GOLANGCI_LINT_VERSION: v2.2.1
  GOLANGCI_LINT: "{{.TOOLS_FOLDER}}/golangci-lint"
  GOSEC_VERSION: v2.22.4
  GOSEC: "{{.TOOLS_FOLDER}}/gosec"

tasks:
  default:
    cmds:
      - task: build

  run:
    desc: run {{.BINARY_NAME}}
    cmds:
      - task: fmt
      - task: vet
      - "go run main.go {{.CLI_ARGS}}"

  build:
    desc: build {{.BINARY_NAME}}
    cmds:
      - task: fmt
      - task: vet
      - go build -o {{.BIN}} main.go

  build:linux:
    desc: build {{.BINARY_NAME}} for linux
    cmds:
      - task: fmt
      - task: vet
      - GOOS=linux GOARCH=amd64 go build -o {{.BINARY_NAME}}-linux-amd64 main.go

  build:darwin:
    desc: build {{.BINARY_NAME}} for linux
    cmds:
      - task: fmt
      - task: vet
      - GOOS=darwin GOARCH=amd64 go build -o {{.BINARY_NAME}}-darwin-amd64 main.go

  test:
    desc: unit test {{.BINARY_NAME}}
    cmds:
      - task: fmt
      - task: vet
      - go test $(go list ./...) -coverprofile coverage.out

  clean:
    desc: remove {{.BIN}}
    cmds:
      - rm {{.BIN}}

  fmt:
    desc: run go fmt
    cmds:
      - go fmt $(go list ./...)

  vet:
    desc: run go vet
    cmds:
      - go vet $(go list ./...)

  coverage:
    desc: show global coverage
    cmds:
      - go tool cover -func=coverage.out

  lint:
    desc: run golangci-lint
    cmds:
      - task: golangci-lint
      - "{{.GOLANGCI_LINT}} run"

  lint-fix:
    desc: run golangci-lint and perform fix
    cmds:
      - task: golangci-lint
      - "{{.GOLANGCI_LINT}} run --fix"

  sec:
    desc: run gosec
    cmds:
      - task: go-sec
      - "{{.GOSEC}} -exclude=G104,G307 ./..."

  module-verify:
    desc: verify modules
    cmds:
      - go mod tidy && go mod verify

  golangci-lint:
    internal: true
    desc: install golangci-lint
    cmds:
      - GOBIN={{.TOOLS_FOLDER}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}

  go-sec:
    internal: true
    desc: install gosec
    cmds:
      - GOBIN={{.TOOLS_FOLDER}} go install github.com/securego/gosec/v2/cmd/gosec@{{.GOSEC_VERSION}}
